<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script></script><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="ETCDETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。ETCD是CoreOS公司发起的一个开源项目，授权协议为Apache。 核心特性：  将数据存储在集群中的高可用kv存储 允许应用实时监控kv变化 能够容忍单点故障，能够应对网络分区  复杂特性：  底层存储是按照key有序排列的，可以顺序遍历 因为key有序，所以etcd天然支持按目录结果高效遍历 支持复杂事物，提供if…t"><meta name="keywords" content="golang,etcd"><meta property="og:type" content="article"><meta property="og:title" content="Golang etcd api"><meta property="og:url" content="https://enpsl.github.io/2019/01/05/2019-01-05-golang-etcd/index.html"><meta property="og:site_name" content="彭诗亮的博客"><meta property="og:description" content="ETCDETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。ETCD是CoreOS公司发起的一个开源项目，授权协议为Apache。 核心特性：  将数据存储在集群中的高可用kv存储 允许应用实时监控kv变化 能够容忍单点故障，能够应对网络分区  复杂特性：  底层存储是按照key有序排列的，可以顺序遍历 因为key有序，所以etcd天然支持按目录结果高效遍历 支持复杂事物，提供if…t"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/2.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/7.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/5.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/6.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/10.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/8.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/9.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/11.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/13.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-05/12.png"><meta property="og:updated_time" content="2019-03-06T12:51:40.537Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Golang etcd api"><meta name="twitter:description" content="ETCDETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。ETCD是CoreOS公司发起的一个开源项目，授权协议为Apache。 核心特性：  将数据存储在集群中的高可用kv存储 允许应用实时监控kv变化 能够容忍单点故障，能够应对网络分区  复杂特性：  底层存储是按照key有序排列的，可以顺序遍历 因为key有序，所以etcd天然支持按目录结果高效遍历 支持复杂事物，提供if…t"><meta name="twitter:image" content="https://enpsl.github.io/img/in-post/2019-01-05/2.png"><link rel="canonical" href="https://enpsl.github.io/2019/01/05/2019-01-05-golang-etcd/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Golang etcd api | 彭诗亮的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/enpsl/enpsl.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">彭诗亮的博客</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-golang-notes"><a href="/golang-note/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>golang-notes</a></li><li class="menu-item menu-item-resume"><a href="/resume/" rel="section"><i class="menu-item-icon fa fa-fw fa-sticky-note"></i><br>趣味简历示例</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2019/01/05/2019-01-05-golang-etcd/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"><meta itemprop="image" content="/images/pengshiliang.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Golang etcd api</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-01-05 09:30:00" itemprop="dateCreated datePublished" datetime="2019-01-05T09:30:00+08:00">2019-01-05</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-03-06 20:51:40" itemprop="dateModified" datetime="2019-03-06T20:51:40+08:00">2019-03-06</time></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2019/01/05/2019-01-05-golang-etcd/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/2019/01/05/2019-01-05-golang-etcd/" itemprop="commentCount"></span></a></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">11k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">10 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="ETCD"><a href="#ETCD" class="headerlink" title="ETCD"></a>ETCD</h2><p>ETCD是用于共享配置和服务发现的分布式，一致性的KV存储系统。ETCD是CoreOS公司发起的一个开源项目，授权协议为Apache。</p><p>核心特性：</p><ul><li>将数据存储在集群中的高可用kv存储</li><li>允许应用实时监控kv变化</li><li>能够容忍单点故障，能够应对网络分区</li></ul><p>复杂特性：</p><ul><li>底层存储是按照key有序排列的，可以顺序遍历</li><li>因为key有序，所以etcd天然支持按目录结果高效遍历</li><li>支持复杂事物，提供if…then…else的事物能力</li><li>基于租约机制实现key的TTL过期</li></ul><h2 id="客户端连接实例"><a href="#客户端连接实例" class="headerlink" title="客户端连接实例"></a>客户端连接实例</h2><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">        config clientv3.Config</span><br><span class="line">        client *clientv3.Client</span><br><span class="line">        err error</span><br><span class="line">     )</span><br><span class="line"></span><br><span class="line">config = clientv3.Config&#123;</span><br><span class="line">    Endpoints: []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;, <span class="comment">// 集群列表</span></span><br><span class="line">    DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> client, err = clientv3.New(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Printf(<span class="string">"clientv3.New error:"</span>, err)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="api介绍"><a href="#api介绍" class="headerlink" title="api介绍"></a>api介绍</h2><p><strong>kv操作</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> KV <span class="keyword">interface</span> &#123;</span><br><span class="line">    Put(ctx context.Context, key, val <span class="keyword">string</span>, opts ...OpOption) (*PutResponse, error)</span><br><span class="line"></span><br><span class="line">    Get(ctx context.Context, key <span class="keyword">string</span>, opts ...OpOption) (*GetResponse, error)</span><br><span class="line"></span><br><span class="line">    Delete(ctx context.Context, key <span class="keyword">string</span>, opts ...OpOption) (*DeleteResponse, error)</span><br><span class="line"></span><br><span class="line">    Compact(ctx context.Context, rev <span class="keyword">int64</span>, opts ...CompactOption) (*CompactResponse, error)</span><br><span class="line">    Do(ctx context.Context, op Op) (OpResponse, error)</span><br><span class="line"></span><br><span class="line">    Txn(ctx context.Context) Txn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>关于租约</strong><br></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Lease <span class="keyword">interface</span> &#123;</span><br><span class="line"></span><br><span class="line">    Grant(ctx context.Context, ttl <span class="keyword">int64</span>) (*LeaseGrantResponse, error)</span><br><span class="line"></span><br><span class="line">    Revoke(ctx context.Context, id LeaseID) (*LeaseRevokeResponse, error)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    TimeToLive(ctx context.Context, id LeaseID, opts ...LeaseOption) (*LeaseTimeToLiveResponse, error)</span><br><span class="line"></span><br><span class="line">    KeepAlive(ctx context.Context, id LeaseID) (&lt;-<span class="keyword">chan</span> *LeaseKeepAliveResponse, error)</span><br><span class="line"></span><br><span class="line">    KeepAliveOnce(ctx context.Context, id LeaseID) (*LeaseKeepAliveResponse, error)</span><br><span class="line"></span><br><span class="line">    Close() error</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><h3 id="创建、更新key"><a href="#创建、更新key" class="headerlink" title="创建、更新key"></a>创建、更新key</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span>(</span><br><span class="line">       kv clientv3.KV</span><br><span class="line">       putResp *clientv3.PutResponse</span><br><span class="line">   ) </span><br><span class="line">   kv = clientv3.NewKV(client)</span><br><span class="line"><span class="keyword">if</span> putResp, err = kv.Put(context.TODO(), <span class="string">"/cron/jobs/job1"</span>,</span><br><span class="line">	<span class="string">"bye"</span>, clientv3.WithPrevKV()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"kv.Put error:"</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"Revision:"</span>, putResp.Header.Revision)</span><br><span class="line">	<span class="keyword">if</span> putResp.PrevKv != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"value:"</span>, <span class="keyword">string</span>(putResp.PrevKv.Value))</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><table><tr><th>SessionA</th></tr><tr><td>执行创建key脚本</td></tr><tr><td>再次执行创建key脚本</td></tr></table><blockquote><p>clientv3.WithPrevKV()作用是可以获取put之前key的值；<br>操作示例第一次创建<code>hello</code>的key,第二次创建<code>bye</code>的key</p></blockquote><p>输出结果：</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/2.png" alt=""></p><h3 id="删除key"><a href="#删除key" class="headerlink" title="删除key"></a>删除key</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span>(</span><br><span class="line">    kv clientv3.KV</span><br><span class="line">    delResp *clientv3.DeleteResponse</span><br><span class="line">    kvPair *mvccpb.KeyValue</span><br><span class="line">) </span><br><span class="line"><span class="keyword">if</span> delResp, err = kv.Delete(context.TODO(), <span class="string">"/cron/jobs/job1"</span>, clientv3.WithPrevKV()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"kv.delete error:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"><span class="comment">//被删除之前的value是什么</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(delResp.PrevKvs) != <span class="number">0</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> _, kvPair = <span class="keyword">range</span> delResp.PrevKvs &#123;</span><br><span class="line">        fmt.Println(<span class="string">"删除了"</span>, <span class="keyword">string</span>(kvPair.Key), <span class="keyword">string</span>(kvPair.Value))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/7.png" alt=""></p><h3 id="查询key"><a href="#查询key" class="headerlink" title="查询key"></a>查询key</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span>(</span><br><span class="line">       kv clientv3.KV</span><br><span class="line">       getResp *clientv3.GetResponse</span><br><span class="line">   ) </span><br><span class="line">   <span class="keyword">if</span> getResp, err = kv.Get(context.TODO(), <span class="string">"/cron/jobs/job1"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"kv.Put error:"</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">//fmt.Println(getResp.Kvs, getResp.Count)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> getResp, err = kv.Get(context.TODO(), <span class="string">"/cron/jobs/job1"</span>, clientv3.WithCountOnly()); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"kv.Put error:"</span>, err)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	fmt.Println(getResp.Kvs, getResp.Count)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>输出结果</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/5.png" alt=""></p><p>加入clientv3.WithCountOnly()输出结果</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/6.png" alt=""></p><blockquote><p>clientv3.WithCountOnly() 只输出count值</p></blockquote><h3 id="watch-key"><a href="#watch-key" class="headerlink" title="watch key"></a>watch key</h3><p>简单demo：</p><blockquote><p>主要工作是开一个新的协程去模拟kv的删除更新操作,用main协程去监听key的put,delete操作，并在5秒后取消监听</p></blockquote><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">	config clientv3.Config</span><br><span class="line">	client *clientv3.Client</span><br><span class="line">	err error</span><br><span class="line">	kv clientv3.KV</span><br><span class="line">	watcher clientv3.Watcher</span><br><span class="line">	getResp *clientv3.GetResponse</span><br><span class="line">	watchStartRevision <span class="keyword">int64</span></span><br><span class="line">	watchRespChan &lt;-<span class="keyword">chan</span> clientv3.WatchResponse</span><br><span class="line">	watchResp clientv3.WatchResponse</span><br><span class="line">	event *clientv3.Event</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端配置</span></span><br><span class="line">config = clientv3.Config&#123;</span><br><span class="line">	Endpoints: []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">	DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line"><span class="keyword">if</span> client, err = clientv3.New(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// KV</span></span><br><span class="line">kv = clientv3.NewKV(client)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 模拟etcd中KV的变化</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		kv.Put(context.TODO(), <span class="string">"/cron/jobs/job3"</span>, <span class="string">"i am job3"</span>)</span><br><span class="line"></span><br><span class="line">		kv.Delete(context.TODO(), <span class="string">"/cron/jobs/job3"</span>)</span><br><span class="line"></span><br><span class="line">		time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先GET到当前的值，并监听后续变化</span></span><br><span class="line"><span class="keyword">if</span> getResp, err = kv.Get(context.TODO(), <span class="string">"/cron/jobs/job3"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在key是存在的</span></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">len</span>(getResp.Kvs) != <span class="number">0</span> &#123;</span><br><span class="line">	fmt.Println(<span class="string">"当前值:"</span>, <span class="keyword">string</span>(getResp.Kvs[<span class="number">0</span>].Value))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当前etcd集群事务ID, 单调递增的</span></span><br><span class="line">watchStartRevision = getResp.Header.Revision + <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个watcher</span></span><br><span class="line">watcher = clientv3.NewWatcher(client)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 启动监听</span></span><br><span class="line">fmt.Println(<span class="string">"从该版本向后监听:"</span>, watchStartRevision)</span><br><span class="line"></span><br><span class="line">ctx, cancelFunc := context.WithCancel(context.TODO())</span><br><span class="line">time.AfterFunc(<span class="number">5</span> * time.Second, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	cancelFunc()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">watchRespChan = watcher.Watch(ctx, <span class="string">"/cron/jobs/job3"</span>, clientv3.WithRev(watchStartRevision))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 处理kv变化事件</span></span><br><span class="line"><span class="keyword">for</span> watchResp = <span class="keyword">range</span> watchRespChan &#123;</span><br><span class="line">	<span class="keyword">for</span> _, event = <span class="keyword">range</span> watchResp.Events &#123;</span><br><span class="line">		<span class="keyword">switch</span> event.Type &#123;</span><br><span class="line">		<span class="keyword">case</span> mvccpb.PUT:</span><br><span class="line">			fmt.Println(<span class="string">"修改为:"</span>, <span class="keyword">string</span>(event.Kv.Value), <span class="string">"Revision:"</span>, event.Kv.CreateRevision, event.Kv.ModRevision)</span><br><span class="line">		<span class="keyword">case</span> mvccpb.DELETE:</span><br><span class="line">			fmt.Println(<span class="string">"删除了"</span>, <span class="string">"Revision:"</span>, event.Kv.ModRevision)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印结果:</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/10.png" alt=""></p><h3 id="申请租约"><a href="#申请租约" class="headerlink" title="申请租约"></a>申请租约</h3><p>简单demo：</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">	config clientv3.Config</span><br><span class="line">	client *clientv3.Client</span><br><span class="line">	err error</span><br><span class="line">	lease clientv3.Lease</span><br><span class="line">	leaseResp *clientv3.LeaseGrantResponse</span><br><span class="line">	leaseId clientv3.LeaseID</span><br><span class="line">	kv clientv3.KV</span><br><span class="line">	putResp *clientv3.PutResponse</span><br><span class="line">	getResp *clientv3.GetResponse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">config = clientv3.Config&#123;</span><br><span class="line">	Endpoints: []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;, <span class="comment">// 集群列表</span></span><br><span class="line">	DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> client, err = clientv3.New(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"clientv3.New error:"</span>, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//申请一个4秒生周期的租约</span></span><br><span class="line">lease = clientv3.NewLease(client)</span><br><span class="line"><span class="keyword">if</span> leaseResp, err = lease.Grant(context.TODO(), <span class="number">4</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"lease.Grant error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//拿到租约id</span></span><br><span class="line">leaseId = leaseResp.ID</span><br><span class="line"></span><br><span class="line"><span class="comment">//put一个key</span></span><br><span class="line">kv = clientv3.NewKV(client)</span><br><span class="line"><span class="keyword">if</span> putResp, err = kv.Put(context.TODO(), <span class="string">"/cron/jobs/job2"</span>,</span><br><span class="line">	<span class="string">"bye"</span>, clientv3.WithLease(leaseId)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"kv.Put error:"</span>, err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"写入成功："</span>, putResp.Header.Revision)</span><br><span class="line"><span class="comment">//循环检测租约是否过期</span></span><br><span class="line"><span class="keyword">for</span>  &#123;</span><br><span class="line">	<span class="keyword">if</span> getResp, err = kv.Get(context.TODO(), <span class="string">"/cron/jobs/job2"</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		log.Printf(<span class="string">"kv.Put error:"</span>, err)</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> getResp.Count == <span class="number">0</span> &#123;</span><br><span class="line">		fmt.Println(<span class="string">"kv过期了"</span>)</span><br><span class="line">		<span class="keyword">break</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	fmt.Println(<span class="string">"还未过期："</span>, getResp.Kvs)</span><br><span class="line">	time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>打印结果:</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/8.png" alt=""></p><h3 id="租约续约"><a href="#租约续约" class="headerlink" title="租约续约"></a>租约续约</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">       keepRespChan &lt;-<span class="keyword">chan</span> *clientv3.LeaseKeepAliveResponse</span><br><span class="line">       keepResp *clientv3.LeaseKeepAliveResponse</span><br><span class="line">   )</span><br><span class="line">   <span class="comment">//租约续租</span></span><br><span class="line"><span class="keyword">if</span> keepRespChan, err = lease.KeepAlive(context.TODO(), leaseId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//消费keepRespChan</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span>  &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> keepResp = &lt;-keepRespChan:</span><br><span class="line">			<span class="keyword">if</span> keepRespChan == <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">"租约已经失效了"</span>)</span><br><span class="line">				<span class="keyword">goto</span> END</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;	<span class="comment">// 每秒会续租一次, 所以就会受到一次应答</span></span><br><span class="line">				fmt.Println(<span class="string">"收到自动续租应答:"</span>, keepResp.ID)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	END:</span><br><span class="line">&#125;()</span><br></pre></td></tr></table></figure><p>打印结果:</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/9.png" alt=""></p><h3 id="op操作"><a href="#op操作" class="headerlink" title="op操作"></a>op操作</h3><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">	config clientv3.Config</span><br><span class="line">	client *clientv3.Client</span><br><span class="line">	err error</span><br><span class="line">	kv clientv3.KV</span><br><span class="line">	op clientv3.Op</span><br><span class="line">	opResp clientv3.OpResponse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端配置</span></span><br><span class="line">config = clientv3.Config&#123;</span><br><span class="line">	Endpoints: []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">	DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line"><span class="keyword">if</span> client, err = clientv3.New(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// KV</span></span><br><span class="line">kv = clientv3.NewKV(client)</span><br><span class="line"></span><br><span class="line">op = clientv3.OpPut(<span class="string">"/cron/jobs/job4"</span>, <span class="string">"opPut"</span>)</span><br><span class="line"><span class="keyword">if</span> opResp, err = kv.Do(context.TODO(), op); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"clientv3.OpPut error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"写入Revision："</span>, opResp.Put().Header.Revision)</span><br><span class="line"></span><br><span class="line">op = clientv3.OpGet(<span class="string">"/cron/jobs/job4"</span>)</span><br><span class="line"><span class="keyword">if</span> opResp, err = kv.Do(context.TODO(), op); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"clientv3.OpGet error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"读取Revision："</span>, opResp.Get().Kvs[<span class="number">0</span>].ModRevision)</span><br><span class="line">fmt.Println(<span class="string">"读取Value："</span>, <span class="keyword">string</span>(opResp.Get().Kvs[<span class="number">0</span>].Value))</span><br></pre></td></tr></table></figure><p>打印结果:</p><p><img src="https://enpsl.github.io/img/in-post/2019-01-05/11.png" alt=""></p><h3 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h3><p><strong>上锁</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   lease = clientv3.NewLease(client)</span><br><span class="line"><span class="comment">//申请一个5秒生周期的租约</span></span><br><span class="line"><span class="keyword">if</span> leaseResp, err = lease.Grant(context.TODO(), <span class="number">5</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"lease.Grant error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//拿到租约id</span></span><br><span class="line">leaseId = leaseResp.ID</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备一个用于取消自动续租的context</span></span><br><span class="line">ctx, cancelFunc = context.WithCancel(context.TODO())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5秒后会取消自动续租</span></span><br><span class="line"><span class="keyword">if</span> keepRespChan, err = lease.KeepAlive(ctx, leaseId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>抢锁</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// 创建事务</span></span><br><span class="line">txn = kv.Txn(context.TODO())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义事务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果key不存在</span></span><br><span class="line">txn.If(clientv3.Compare(clientv3.CreateRevision(<span class="string">"/cron/lock/job5"</span>), <span class="string">"="</span>, <span class="number">0</span>)).</span><br><span class="line">	Then(clientv3.OpPut(<span class="string">"/cron/lock/job5"</span>, <span class="string">"xxx"</span>, clientv3.WithLease(leaseId))).</span><br><span class="line">	Else(clientv3.OpGet(<span class="string">"/cron/lock/job5"</span>)) <span class="comment">// 否则抢锁失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交事务</span></span><br><span class="line"><span class="keyword">if</span> txnResp, err = txn.Commit(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span> <span class="comment">// 没有问题</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否抢到了锁</span></span><br><span class="line"><span class="keyword">if</span> !txnResp.Succeeded &#123;</span><br><span class="line">	fmt.Println(<span class="string">"锁被占用:"</span>, <span class="keyword">string</span>(txnResp.Responses[<span class="number">0</span>].GetResponseRange().Kvs[<span class="number">0</span>].Value))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>处理业务</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(<span class="string">"处理任务"</span>)</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br></pre></td></tr></table></figure><p><strong>释放锁</strong></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">// defer 会把租约释放掉, 关联的KV就被删除了</span></span><br><span class="line"><span class="comment">// 确保函数退出后, 自动续租会停止</span></span><br><span class="line"><span class="keyword">defer</span> cancelFunc()</span><br><span class="line"><span class="keyword">defer</span> lease.Revoke(context.TODO(), leaseId)</span><br></pre></td></tr></table></figure><p><strong>完整Demo</strong><br></p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">   <span class="keyword">var</span> (</span><br><span class="line">	config clientv3.Config</span><br><span class="line">	client *clientv3.Client</span><br><span class="line">	err error</span><br><span class="line">	lease clientv3.Lease</span><br><span class="line">	leaseResp *clientv3.LeaseGrantResponse</span><br><span class="line">	leaseId clientv3.LeaseID</span><br><span class="line">	kv clientv3.KV</span><br><span class="line">	keepRespChan &lt;-<span class="keyword">chan</span> *clientv3.LeaseKeepAliveResponse</span><br><span class="line">	keepResp *clientv3.LeaseKeepAliveResponse</span><br><span class="line">	ctx context.Context</span><br><span class="line">	cancelFunc context.CancelFunc</span><br><span class="line">	txn clientv3.Txn</span><br><span class="line">	txnResp *clientv3.TxnResponse</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 客户端配置</span></span><br><span class="line">config = clientv3.Config&#123;</span><br><span class="line">	Endpoints: []<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:2379"</span>&#125;,</span><br><span class="line">	DialTimeout: <span class="number">5</span> * time.Second,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 建立连接</span></span><br><span class="line"><span class="keyword">if</span> client, err = clientv3.New(config); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// KV</span></span><br><span class="line">kv = clientv3.NewKV(client)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1, 上锁 (创建租约, 自动续租, 拿着租约去抢占一个key)</span></span><br><span class="line">lease = clientv3.NewLease(client)</span><br><span class="line"><span class="comment">//申请一个5秒生周期的租约</span></span><br><span class="line"><span class="keyword">if</span> leaseResp, err = lease.Grant(context.TODO(), <span class="number">5</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	log.Printf(<span class="string">"lease.Grant error:"</span>, err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//拿到租约id</span></span><br><span class="line">leaseId = leaseResp.ID</span><br><span class="line"></span><br><span class="line"><span class="comment">// 准备一个用于取消自动续租的context</span></span><br><span class="line">ctx, cancelFunc = context.WithCancel(context.TODO())</span><br><span class="line"></span><br><span class="line"><span class="comment">// defer 会把租约释放掉, 关联的KV就被删除了</span></span><br><span class="line"><span class="comment">// 确保函数退出后, 自动续租会停止</span></span><br><span class="line"><span class="keyword">defer</span> cancelFunc()</span><br><span class="line"><span class="keyword">defer</span> lease.Revoke(context.TODO(), leaseId)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5秒后会取消自动续租</span></span><br><span class="line"><span class="keyword">if</span> keepRespChan, err = lease.KeepAlive(ctx, leaseId); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//处理续约应答的协程</span></span><br><span class="line"><span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span>  &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> keepResp = &lt;-keepRespChan:</span><br><span class="line">			<span class="keyword">if</span> keepRespChan == <span class="literal">nil</span> &#123;</span><br><span class="line">				fmt.Println(<span class="string">"租约已经失效了"</span>)</span><br><span class="line">				<span class="keyword">goto</span> END</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;	<span class="comment">// 每秒会续租一次, 所以就会受到一次应答</span></span><br><span class="line">				fmt.Println(<span class="string">"收到自动续租应答:"</span>, keepResp.ID)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">END:</span><br><span class="line">&#125;()</span><br><span class="line"></span><br><span class="line"><span class="comment">//  if 不存在key， then 设置它, else 抢锁失败</span></span><br><span class="line">kv = clientv3.NewKV(client)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建事务</span></span><br><span class="line">txn = kv.Txn(context.TODO())</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义事务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果key不存在</span></span><br><span class="line">txn.If(clientv3.Compare(clientv3.CreateRevision(<span class="string">"/cron/lock/job5"</span>), <span class="string">"="</span>, <span class="number">0</span>)).</span><br><span class="line">	Then(clientv3.OpPut(<span class="string">"/cron/lock/job5"</span>, <span class="string">"xxx"</span>, clientv3.WithLease(leaseId))).</span><br><span class="line">	Else(clientv3.OpGet(<span class="string">"/cron/lock/job5"</span>)) <span class="comment">// 否则抢锁失败</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 提交事务</span></span><br><span class="line"><span class="keyword">if</span> txnResp, err = txn.Commit(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">	fmt.Println(err)</span><br><span class="line">	<span class="keyword">return</span> <span class="comment">// 没有问题</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 判断是否抢到了锁</span></span><br><span class="line"><span class="keyword">if</span> !txnResp.Succeeded &#123;</span><br><span class="line">	fmt.Println(<span class="string">"锁被占用:"</span>, <span class="keyword">string</span>(txnResp.Responses[<span class="number">0</span>].GetResponseRange().Kvs[<span class="number">0</span>].Value))</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2, 处理业务</span></span><br><span class="line"></span><br><span class="line">fmt.Println(<span class="string">"处理任务"</span>)</span><br><span class="line">time.Sleep(<span class="number">5</span> * time.Second)</span><br></pre></td></tr></table></figure><p></p><p><table><tr><th>SessionA</th><th>SessionB</th></tr><tr><td>go run main.go</td><td>go run main.go</td></tr></table><br><img src="https://enpsl.github.io/img/in-post/2019-01-05/13.png" alt=""><br><img src="https://enpsl.github.io/img/in-post/2019-01-05/12.png" alt=""></p><blockquote><p>SesionA先执行main.go先获得一个锁，随后执行SessionB main.go,会提示锁被占用</p></blockquote><blockquote><p>参考</p><ul><li><a href="https://godoc.org/github.com/coreos/etcd/clientv3" target="_blank" rel="noopener">《Go Etcd Docs》</a></li></ul></blockquote></div><div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/golang/" rel="tag"><i class="fa fa-tag"></i> golang</a><a href="/tags/etcd/" rel="tag"><i class="fa fa-tag"></i> etcd</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/01/2019-01-01-golang-cron/" rel="next" title="golang 调度多个cron"><i class="fa fa-chevron-left"></i> golang 调度多个cron</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/01/19/2018-01-11-redis-sentinel/" rel="prev" title="Redis哨兵">Redis哨兵<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/pengshiliang.jpg" alt="enpsl"><p class="site-author-name" itemprop="name">enpsl</p><p class="site-description motion-element" itemprop="description">my blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/enpsl" title="GitHub &rarr; https://github.com/enpsl" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://weibo.com/pslpro" title="Weibo &rarr; https://weibo.com/pslpro" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> Weibo</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#ETCD"><span class="nav-number">1.</span> <span class="nav-text">ETCD</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#客户端连接实例"><span class="nav-number">2.</span> <span class="nav-text">客户端连接实例</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#api介绍"><span class="nav-number">3.</span> <span class="nav-text">api介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建、更新key"><span class="nav-number">3.1.</span> <span class="nav-text">创建、更新key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除key"><span class="nav-number">3.2.</span> <span class="nav-text">删除key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查询key"><span class="nav-number">3.3.</span> <span class="nav-text">查询key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#watch-key"><span class="nav-number">3.4.</span> <span class="nav-text">watch key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#申请租约"><span class="nav-number">3.5.</span> <span class="nav-text">申请租约</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#租约续约"><span class="nav-number">3.6.</span> <span class="nav-text">租约续约</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#op操作"><span class="nav-number">3.7.</span> <span class="nav-text">op操作</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式锁"><span class="nav-number">3.8.</span> <span class="nav-text">分布式锁</span></a></li></ol></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">189k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">2:52</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"DEj2x1d388d2HxBNMAEETUPf-gzGzoHsz",appKey:"pMbUNFO55ydSxGeUNjhYJEUu",placeholder:"免登录，直接说",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body><script type="text/javascript" src="/js/src/wechat.js"></script></html>