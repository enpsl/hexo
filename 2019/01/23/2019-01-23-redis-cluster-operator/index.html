<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script></script><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="集群伸缩原理 集群伸缩=槽和数据在节点之间的移动  扩容集群准备新节点新节点：  集群模式 配置和其它节点统一 启动后仍是孤儿节点   加入集群12cluster meet 127.0.0.1 6385cluster meet 127.0.0.1 6386  加入后的效果  加入集群的作用：  为它迁移槽和数据实现扩容 作为从节点负责故障转移  1redis-cli --cluster add-n"><meta name="keywords" content="redis"><meta property="og:type" content="article"><meta property="og:title" content="Redis cluster 伸缩"><meta property="og:url" content="https://enpsl.github.io/2019/01/23/2019-01-23-redis-cluster-operator/index.html"><meta property="og:site_name" content="彭诗亮的博客"><meta property="og:description" content="集群伸缩原理 集群伸缩=槽和数据在节点之间的移动  扩容集群准备新节点新节点：  集群模式 配置和其它节点统一 启动后仍是孤儿节点   加入集群12cluster meet 127.0.0.1 6385cluster meet 127.0.0.1 6386  加入后的效果  加入集群的作用：  为它迁移槽和数据实现扩容 作为从节点负责故障转移  1redis-cli --cluster add-n"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/1.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/2.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/3.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/4.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/6.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/7.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/8.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/9.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/10.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/11.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/12.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/13.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/14.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/15.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/16.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/17.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/18.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-23/19.png"><meta property="og:updated_time" content="2019-03-06T12:51:40.537Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis cluster 伸缩"><meta name="twitter:description" content="集群伸缩原理 集群伸缩=槽和数据在节点之间的移动  扩容集群准备新节点新节点：  集群模式 配置和其它节点统一 启动后仍是孤儿节点   加入集群12cluster meet 127.0.0.1 6385cluster meet 127.0.0.1 6386  加入后的效果  加入集群的作用：  为它迁移槽和数据实现扩容 作为从节点负责故障转移  1redis-cli --cluster add-n"><meta name="twitter:image" content="https://enpsl.github.io/img/in-post/2019-01-23/1.png"><link rel="canonical" href="https://enpsl.github.io/2019/01/23/2019-01-23-redis-cluster-operator/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Redis cluster 伸缩 | 彭诗亮的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/enpsl/enpsl.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">彭诗亮的博客</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-golang-notes"><a href="/golang-note/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>golang-notes</a></li><li class="menu-item menu-item-resume"><a href="/resume/" rel="section"><i class="menu-item-icon fa fa-fw fa-sticky-note"></i><br>趣味简历示例</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2019/01/23/2019-01-23-redis-cluster-operator/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"><meta itemprop="image" content="/images/pengshiliang.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis cluster 伸缩</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-01-23 22:30:00" itemprop="dateCreated datePublished" datetime="2019-01-23T22:30:00+08:00">2019-01-23</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-03-06 20:51:40" itemprop="dateModified" datetime="2019-03-06T20:51:40+08:00">2019-03-06</time></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2019/01/23/2019-01-23-redis-cluster-operator/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/2019/01/23/2019-01-23-redis-cluster-operator/" itemprop="commentCount"></span></a></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">2.8k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">3 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="集群伸缩原理"><a href="#集群伸缩原理" class="headerlink" title="集群伸缩原理"></a>集群伸缩原理</h2><p><img src="/img/in-post/2019-01-23/1.png" alt=""><br><img src="/img/in-post/2019-01-23/2.png" alt=""></p><center style="font-weight:700">集群伸缩=槽和数据在节点之间的移动</center><h2 id="扩容集群"><a href="#扩容集群" class="headerlink" title="扩容集群"></a>扩容集群</h2><h3 id="准备新节点"><a href="#准备新节点" class="headerlink" title="准备新节点"></a>准备新节点</h3><p>新节点：</p><ul><li>集群模式</li><li>配置和其它节点统一</li><li>启动后仍是孤儿节点</li></ul><p><img src="/img/in-post/2019-01-23/3.png" alt=""></p><h3 id="加入集群"><a href="#加入集群" class="headerlink" title="加入集群"></a>加入集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster meet 127.0.0.1 6385</span><br><span class="line">cluster meet 127.0.0.1 6386</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-01-23/4.png" alt=""></p><center style="font-weight:700">加入后的效果</center><p>加入集群的作用：</p><ul><li>为它迁移槽和数据实现扩容</li><li>作为从节点负责故障转移</li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster add-node new_host:new_port existing_host:existing_port --cluster-slave --cluster-master-id &lt;arg&gt;</span><br></pre></td></tr></table></figure><blockquote><p>建议使用redis-trib.rb能够避免新节点已经加入了其它集群，造成故障</p></blockquote><h3 id="迁移槽和数据"><a href="#迁移槽和数据" class="headerlink" title="迁移槽和数据"></a>迁移槽和数据</h3><h4 id="槽迁移计划"><a href="#槽迁移计划" class="headerlink" title="槽迁移计划:"></a>槽迁移计划:</h4><p><img src="/img/in-post/2019-01-23/6.png" alt=""><br><img src="/img/in-post/2019-01-23/7.png" alt=""></p><h4 id="迁移数据："><a href="#迁移数据：" class="headerlink" title="迁移数据："></a>迁移数据：</h4><ol><li>对目标节点发送: cluster setslot{slot} importing {sourceNodeId}命令，让目标节点准备导入槽的数据。</li><li>对源节点发送: cluster setslot{slot} migrating {targetNodeId}命令，让源节点准备迁出槽的数据。</li><li>源节点循环执行: cluster getkeysinslot{slot}{count}命令，每次获取count个属于槽的键。</li><li>在源节点执行: migrate {targetIP}{targetPort} key 0 {timeout}命令把指定key迁移。</li><li>重复执行3-4直到槽下所有数据节点均迁移到目标节点。</li><li>向集群内所有主节点发送cluster setslot{slot} node {targetNodeId}命令，通知槽分配给目标节点。</li></ol><h4 id="数据迁移伪python代码"><a href="#数据迁移伪python代码" class="headerlink" title="数据迁移伪python代码:"></a>数据迁移伪python代码:</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">move_slot</span><span class="params">(source,target,slot)</span>:</span></span><br><span class="line">    <span class="comment">#目标节点准备导入槽slot</span></span><br><span class="line">    target.cluster(<span class="string">"setslot"</span>,slot,<span class="string">"importing"</span>,source.nodeID)</span><br><span class="line">    <span class="comment">#目标节点准备全出槽slot</span></span><br><span class="line">    target.cluster(<span class="string">"setslot"</span>,slot,<span class="string">"migrating"</span>,source.nodeID) </span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</span><br><span class="line">        <span class="comment">#批量从源节点获取键</span></span><br><span class="line">        keys = source.cluster(<span class="string">"getkeysinslot"</span>,slot,pipeline_size)</span><br><span class="line">        <span class="keyword">if</span> keys.length ==<span class="number">0</span>:</span><br><span class="line">            <span class="comment">#键列表为空时，退出循环</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="comment">#批量迁移键到目标节点</span></span><br><span class="line">    source.call(<span class="string">"migrate"</span>,target.host,target.port,<span class="string">""</span>,timeout,<span class="string">"keys"</span>)</span><br><span class="line">    <span class="comment">#向集群所有主节点通知槽slot被分配给目标节点</span></span><br><span class="line">    <span class="keyword">for</span> node <span class="keyword">in</span> nodes:</span><br><span class="line">        <span class="keyword">if</span> node.flag ==<span class="string">"slave"</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        node.cluster(<span class="string">"setslot"</span>,slot,<span class="string">"node"</span>,target.nodeID)</span><br></pre></td></tr></table></figure><h4 id="pipline迁移"><a href="#pipline迁移" class="headerlink" title="pipline迁移"></a>pipline迁移</h4><p><img src="/img/in-post/2019-01-23/8.png" alt=""></p><blockquote><p>3.0.6 版本pipline数据迁移会有丢失数据bug，在3.2.8已解决</p></blockquote><h2 id="扩容演示"><a href="#扩容演示" class="headerlink" title="扩容演示"></a>扩容演示</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><img src="/img/in-post/2019-01-23/9.png" alt=""><br>当前集群是三主三从结构，此时我们加入两个新节点7006,7007。7007是7006的从节点，我们需要从7001,7002节点把一部分数据迁移给7006。<br>配置准备:<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed <span class="string">'s/7000/7006/g'</span> redis-7000.conf &gt; redis-7006.conf</span><br><span class="line">sed <span class="string">'s/7000/7007/g'</span> redis-7000.conf &gt; redis-7007.conf</span><br></pre></td></tr></table></figure><p></p><h3 id="meet"><a href="#meet" class="headerlink" title="meet:"></a>meet:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7006</span><br><span class="line">redis-cli -p 7000 cluster meet 127.0.0.1 7007</span><br></pre></td></tr></table></figure><h3 id="replicate"><a href="#replicate" class="headerlink" title="replicate:"></a>replicate:</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 7007 cluster replicate d57d27051ce9db7752f894394b621368f9e0a058</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-01-23/10.png" alt=""></p><blockquote><p>此时7007已经属于7006的从节点</p></blockquote><h3 id="迁移数据：-1"><a href="#迁移数据：-1" class="headerlink" title="迁移数据："></a>迁移数据：</h3><blockquote><p>由于槽数量比较多，所以这里使用redis-trib来迁移<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard 127.0.0.1 7000</span><br></pre></td></tr></table></figure><p></p></blockquote><p><img src="/img/in-post/2019-01-23/11.png" alt=""><br>此时给我们提示出了当前集群的信息，由于我们现在是4个主节点，所以需要分成四等份来支持向master写入数据<br><img src="/img/in-post/2019-01-23/12.png" alt=""><br><img src="/img/in-post/2019-01-23/13.png" alt=""></p><p>槽迁移后的信息：<br><img src="/img/in-post/2019-01-23/14.png" alt=""></p><h2 id="收缩集群"><a href="#收缩集群" class="headerlink" title="收缩集群"></a>收缩集群</h2><h3 id="下线迁移槽"><a href="#下线迁移槽" class="headerlink" title="下线迁移槽"></a>下线迁移槽</h3><p><img src="/img/in-post/2019-01-23/15.png" alt=""></p><h3 id="忘记节点"><a href="#忘记节点" class="headerlink" title="忘记节点"></a>忘记节点</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli&gt;cluster forget &#123;downNodeId&#125;</span><br></pre></td></tr></table></figure><p><img src="/img/in-post/2019-01-23/16.png" alt=""></p><h3 id="关闭节点"><a href="#关闭节点" class="headerlink" title="关闭节点"></a>关闭节点</h3><h2 id="收缩集群演示"><a href="#收缩集群演示" class="headerlink" title="收缩集群演示"></a>收缩集群演示</h2><p>例：下线7006，7007</p><h3 id="迁移槽："><a href="#迁移槽：" class="headerlink" title="迁移槽："></a>迁移槽：</h3><p>迁移过程命令：</p><p>redis-cli –cluster reshard –cluster-from {7006nodeid} –cluster-to 7000{7000nodeid} –cluster-slots {slot num} 127.0.0.1:7006</p><p>redis-cli –cluster reshard –cluster-from {7006nodeid} –cluster-to 7001{7001nodeid} –cluster-slots {slot num} 127.0.0.1:7006</p><p>redis-cli –cluster reshard –cluster-from {7006nodeid} –cluster-to 7002{7002nodeid} –cluster-slots {slot num} 127.0.0.1:7006</p><p>迁移到7000示例：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster reshard --cluster-from d57d27051ce9db7752f894394b621368f9e0a058 --cluster-to 092fd7c3cf19693eddec5c0fae9894d681023ce5 --cluster-slots 1365 127.0.0.1:7006</span><br></pre></td></tr></table></figure><p></p><p>之后选择yes即可</p><p><img src="/img/in-post/2019-01-23/17.png" alt=""><br>可观察出0-1364的槽节点以迁移完毕，重复上述步骤，迁移剩余的槽</p><p>迁移后：<br><img src="/img/in-post/2019-01-23/18.png" alt=""></p><h3 id="忘记节点："><a href="#忘记节点：" class="headerlink" title="忘记节点："></a>忘记节点：</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli --cluster del-node 127.0.0.1:7000 d57d27051ce9db7752f894394b621368f9e0a058</span><br></pre></td></tr></table></figure><blockquote><p>需要先下线从节点在下线主节点，否则会发生故障转移</p></blockquote><h3 id="完成缩容"><a href="#完成缩容" class="headerlink" title="完成缩容"></a>完成缩容</h3><p><img src="/img/in-post/2019-01-23/19.png" alt=""></p></div><div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/redis/" rel="tag"><i class="fa fa-tag"></i> redis</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/20/2019-01-20-redis-cluster/" rel="next" title="Redis cluster"><i class="fa fa-chevron-left"></i> Redis cluster</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/01/24/2019-01-24-redis-cluster-route/" rel="prev" title="Redis cluster 客户端路由">Redis cluster 客户端路由<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/pengshiliang.jpg" alt="enpsl"><p class="site-author-name" itemprop="name">enpsl</p><p class="site-description motion-element" itemprop="description">my blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">37</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">22</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/enpsl" title="GitHub &rarr; https://github.com/enpsl" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://weibo.com/pslpro" title="Weibo &rarr; https://weibo.com/pslpro" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> Weibo</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#集群伸缩原理"><span class="nav-number">1.</span> <span class="nav-text">集群伸缩原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩容集群"><span class="nav-number">2.</span> <span class="nav-text">扩容集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备新节点"><span class="nav-number">2.1.</span> <span class="nav-text">准备新节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#加入集群"><span class="nav-number">2.2.</span> <span class="nav-text">加入集群</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迁移槽和数据"><span class="nav-number">2.3.</span> <span class="nav-text">迁移槽和数据</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#槽迁移计划"><span class="nav-number">2.3.1.</span> <span class="nav-text">槽迁移计划:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#迁移数据："><span class="nav-number">2.3.2.</span> <span class="nav-text">迁移数据：</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#数据迁移伪python代码"><span class="nav-number">2.3.3.</span> <span class="nav-text">数据迁移伪python代码:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#pipline迁移"><span class="nav-number">2.3.4.</span> <span class="nav-text">pipline迁移</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#扩容演示"><span class="nav-number">3.</span> <span class="nav-text">扩容演示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境准备"><span class="nav-number">3.1.</span> <span class="nav-text">环境准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#meet"><span class="nav-number">3.2.</span> <span class="nav-text">meet:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#replicate"><span class="nav-number">3.3.</span> <span class="nav-text">replicate:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#迁移数据：-1"><span class="nav-number">3.4.</span> <span class="nav-text">迁移数据：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#收缩集群"><span class="nav-number">4.</span> <span class="nav-text">收缩集群</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下线迁移槽"><span class="nav-number">4.1.</span> <span class="nav-text">下线迁移槽</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#忘记节点"><span class="nav-number">4.2.</span> <span class="nav-text">忘记节点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭节点"><span class="nav-number">4.3.</span> <span class="nav-text">关闭节点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#收缩集群演示"><span class="nav-number">5.</span> <span class="nav-text">收缩集群演示</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#迁移槽："><span class="nav-number">5.1.</span> <span class="nav-text">迁移槽：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#忘记节点："><span class="nav-number">5.2.</span> <span class="nav-text">忘记节点：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#完成缩容"><span class="nav-number">5.3.</span> <span class="nav-text">完成缩容</span></a></li></ol></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">241k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">3:39</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"DEj2x1d388d2HxBNMAEETUPf-gzGzoHsz",appKey:"pMbUNFO55ydSxGeUNjhYJEUu",placeholder:"免登录，直接说",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body><script type="text/javascript" src="/js/src/wechat.js"></script></html>