<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script></script><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="Redis Sentinel基本架构 多个sentinel发现并确认master有问题 选举出一个sentinel作为领导 选出一个salve作为master 通知其余slave成为新的master的slave 通知客户端主从变化 等待master复活成为新的master的slave  安装与配置 配置开启主从节点 配置开启sentinel监控master节点  Redis主节点启动redis-7"><meta name="keywords" content="redis"><meta property="og:type" content="article"><meta property="og:title" content="Redis哨兵"><meta property="og:url" content="https://enpsl.github.io/2019/01/19/2018-01-11-redis-sentinel/index.html"><meta property="og:site_name" content="彭诗亮的博客"><meta property="og:description" content="Redis Sentinel基本架构 多个sentinel发现并确认master有问题 选举出一个sentinel作为领导 选出一个salve作为master 通知其余slave成为新的master的slave 通知客户端主从变化 等待master复活成为新的master的slave  安装与配置 配置开启主从节点 配置开启sentinel监控master节点  Redis主节点启动redis-7"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/1.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/2.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/3.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/4.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/5.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/6.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/7.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/8.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/9.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/10.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/11.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/12.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/13.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/16.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/14.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/15.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/17.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/18.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-01-19/19.png"><meta property="og:updated_time" content="2019-03-06T12:51:40.536Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Redis哨兵"><meta name="twitter:description" content="Redis Sentinel基本架构 多个sentinel发现并确认master有问题 选举出一个sentinel作为领导 选出一个salve作为master 通知其余slave成为新的master的slave 通知客户端主从变化 等待master复活成为新的master的slave  安装与配置 配置开启主从节点 配置开启sentinel监控master节点  Redis主节点启动redis-7"><meta name="twitter:image" content="https://enpsl.github.io/img/in-post/2019-01-19/1.png"><link rel="canonical" href="https://enpsl.github.io/2019/01/19/2018-01-11-redis-sentinel/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Redis哨兵 | 彭诗亮的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/enpsl/enpsl.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">彭诗亮的博客</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-golang-notes"><a href="/golang-note/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>golang-notes</a></li><li class="menu-item menu-item-resume"><a href="/resume/" rel="section"><i class="menu-item-icon fa fa-fw fa-sticky-note"></i><br>趣味简历示例</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2019/01/19/2018-01-11-redis-sentinel/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"><meta itemprop="image" content="/images/pengshiliang.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Redis哨兵</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-01-19 23:30:00" itemprop="dateCreated datePublished" datetime="2019-01-19T23:30:00+08:00">2019-01-19</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-03-06 20:51:40" itemprop="dateModified" datetime="2019-03-06T20:51:40+08:00">2019-03-06</time></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2019/01/19/2018-01-11-redis-sentinel/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/2019/01/19/2018-01-11-redis-sentinel/" itemprop="commentCount"></span></a></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">4.6k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">4 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="Redis-Sentinel基本架构"><a href="#Redis-Sentinel基本架构" class="headerlink" title="Redis Sentinel基本架构"></a>Redis Sentinel基本架构</h2><ol><li>多个sentinel发现并确认master有问题</li><li>选举出一个sentinel作为领导</li><li>选出一个salve作为master</li><li>通知其余slave成为新的master的slave</li><li>通知客户端主从变化</li><li>等待master复活成为新的master的slave</li></ol><h2 id="安装与配置"><a href="#安装与配置" class="headerlink" title="安装与配置"></a>安装与配置</h2><ol><li>配置开启主从节点</li><li>配置开启sentinel监控master节点</li></ol><p>Redis主节点<br>启动</p><figure class="highlight plain"><figcaption><span>redis-7000.conf```</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">### redis配置:</span><br><span class="line">主节点:</span><br></pre></td></tr></table></figure><p></p><p>port 7000<br>daemonize yes<br>pidfile /var/run/redis/7000.pid<br>logfile 7000.log<br>dir “${redis-src}/data/“<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">从节点:</span><br></pre></td></tr></table></figure><p></p><p>port 7001<br>daemonize yes<br>pidfile /var/run/redis/7001.pid<br>logfile 7001.log<br>dir “${redis-src}/data/“<br>slaveof 127.0.0.1 7000<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">port 7002</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /var/run/redis/7002.pid</span><br><span class="line">logfile 7002.log</span><br><span class="line">dir &quot;$&#123;redis-src&#125;/data/&quot;</span><br><span class="line">slaveof 127.0.0.1 7000</span><br></pre></td></tr></table></figure><p></p><h3 id="sentinel配置"><a href="#sentinel配置" class="headerlink" title="sentinel配置:"></a>sentinel配置:</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">port $&#123;port&#125;</span><br><span class="line">dir &quot;$&#123;redis-src&#125;/data/&quot;</span><br><span class="line">logfile $&#123;port&#125;.log</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 7000 2 #监控主节点的名字 2对应当两个sentinel发现主节点有问题就发生故障转移</span><br><span class="line">sentinel down-after-millisenconds mymaster 30000 #ping30秒后不通认为有问题</span><br><span class="line">sentinel parallel-sync mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br></pre></td></tr></table></figure><h3 id="安装演示"><a href="#安装演示" class="headerlink" title="安装演示"></a>安装演示</h3><p><strong>配置redis</strong></p><blockquote><p>单机演示实际为能相互ping通的多台机器</p></blockquote><p>1：创建master节点配置</p><p><img src="/img/in-post/2019-01-19/1.png" alt=""></p><p>2：创建7000,7001节点配置</p><p><img src="/img/in-post/2019-01-19/2.png" alt=""><br><img src="/img/in-post/2019-01-19/3.png" alt=""></p><p>3：查看主从状态</p><p><img src="/img/in-post/2019-01-19/4.png" alt=""></p><blockquote><p>到此为止主从的配置搭建完毕了</p></blockquote><p><strong>配置sentinel</strong></p><p>通过官方提供的配置模板导入sentinel配置</p><p><img src="/img/in-post/2019-01-19/5.png" alt=""><br>配置信息：</p><p><img src="/img/in-post/2019-01-19/6.png" alt=""></p><p>查看Sentinel监控状态：</p><p><img src="/img/in-post/2019-01-19/7.png" alt=""></p><p>到此我们可以发现Sentinel已经检测到了matser节点的主从信息，由于我们只启动一个Sentinel所以Sentinel发现的数目为1</p><p>再去看看redis-sentinel-26379.conf的变化:</p><p><img src="/img/in-post/2019-01-19/8.png" alt=""></p><blockquote><p>发现他已经把7000的两个slave节点的信息配置自动写入到了配置文件中</p></blockquote><p>生成另外两个Sentinel配置</p><p><img src="/img/in-post/2019-01-19/9.png" alt=""></p><p>查看sentinel状态</p><p><img src="/img/in-post/2019-01-19/10.png" alt=""></p><blockquote><p>发现26380的Sentinel并没有发现其他节点</p></blockquote><p>查看原因：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat /var/log/redis/26379.log</span><br><span class="line">cat /var/log/redis/26380.log</span><br><span class="line">cat /var/log/redis/26381.log</span><br></pre></td></tr></table></figure><p></p><p><img src="/img/in-post/2019-01-19/11.png" alt=""><br><img src="/img/in-post/2019-01-19/12.png" alt=""></p><p>我们发现三个节点的pid都是一样的，所以需要配置pid<br>编辑26379,26380,26381.conf 去掉配置文件自动生成的myid,并加入<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pidfile &quot;/var/run/redis/redis-sentinel-26379.pid&quot;</span><br><span class="line">pidfile &quot;/var/run/redis/redis-sentinel-26380.pid&quot;</span><br><span class="line">pidfile &quot;/var/run/redis/redis-sentinel-26381.pid&quot;</span><br></pre></td></tr></table></figure><p></p><p><img src="/img/in-post/2019-01-19/13.png" alt=""></p><p>状态已正常</p><h2 id="go客户端"><a href="#go客户端" class="headerlink" title="go客户端"></a>go客户端</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">"fmt"</span></span><br><span class="line">	<span class="string">"github.com/gomodule/redigo/redis"</span></span><br><span class="line">	<span class="string">"github.com/letsfire/redigo"</span></span><br><span class="line">	<span class="string">"github.com/letsfire/redigo/mode"</span></span><br><span class="line">	<span class="string">"github.com/letsfire/redigo/mode/sentinel"</span></span><br><span class="line">	<span class="string">"strconv"</span></span><br><span class="line">	<span class="string">"time"</span></span><br><span class="line">	<span class="string">"log"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="keyword">var</span> (</span><br><span class="line">		i <span class="keyword">int</span></span><br><span class="line">		sentinelMode mode.IMode</span><br><span class="line">	)</span><br><span class="line">	sentinelMode = sentinel.New(</span><br><span class="line">		sentinel.Addrs([]<span class="keyword">string</span>&#123;<span class="string">"127.0.0.1:26379"</span>, <span class="string">"127.0.0.1:26380"</span>, <span class="string">"127.0.0.1:26381"</span>&#125;),</span><br><span class="line">		sentinel.PoolOpts(</span><br><span class="line">			mode.MaxActive(<span class="number">20</span>),       <span class="comment">// 最大连接数，默认0无限制</span></span><br><span class="line">			mode.MaxIdle(<span class="number">0</span>),         <span class="comment">// 最多保持空闲连接数，默认2*runtime.GOMAXPROCS(0)</span></span><br><span class="line">			mode.Wait(<span class="literal">false</span>),        <span class="comment">// 连接耗尽时是否等待，默认false</span></span><br><span class="line">			mode.IdleTimeout(<span class="number">0</span>),     <span class="comment">// 空闲连接超时时间，默认0不超时</span></span><br><span class="line">			mode.MaxConnLifetime(<span class="number">0</span>), <span class="comment">// 连接的生命周期，默认0不失效</span></span><br><span class="line">			mode.TestOnBorrow(<span class="literal">nil</span>),  <span class="comment">// 空间连接取出后检测是否健康，默认nil</span></span><br><span class="line">		),</span><br><span class="line">		sentinel.DialOpts(</span><br><span class="line">			redis.DialReadTimeout(time.Second),    <span class="comment">// 读取超时，默认time.Second</span></span><br><span class="line">			redis.DialWriteTimeout(time.Second),   <span class="comment">// 写入超时，默认time.Second</span></span><br><span class="line">			redis.DialConnectTimeout(time.Second), <span class="comment">// 连接超时，默认500*time.Millisecond</span></span><br><span class="line">			redis.DialPassword(<span class="string">""</span>),                <span class="comment">// 鉴权密码，默认空</span></span><br><span class="line">			redis.DialDatabase(<span class="number">0</span>),                 <span class="comment">// 数据库号，默认0</span></span><br><span class="line">			redis.DialKeepAlive(time.Minute*<span class="number">5</span>),    <span class="comment">// 默认5*time.Minute</span></span><br><span class="line">			redis.DialNetDial(<span class="literal">nil</span>),                <span class="comment">// 自定义dial，默认nil</span></span><br><span class="line">			redis.DialUseTLS(<span class="literal">false</span>),               <span class="comment">// 是否用TLS，默认false</span></span><br><span class="line">			redis.DialTLSSkipVerify(<span class="literal">false</span>),        <span class="comment">// 服务器证书校验，默认false</span></span><br><span class="line">			redis.DialTLSConfig(<span class="literal">nil</span>),              <span class="comment">// 默认nil，详见tls.Config</span></span><br><span class="line">		),</span><br><span class="line">		<span class="comment">// 连接哨兵配置，用法于sentinel.DialOpts()一致</span></span><br><span class="line">		<span class="comment">// 默认未配置的情况则直接使用sentinel.DialOpts()的配置</span></span><br><span class="line">		<span class="comment">// sentinel.SentinelDialOpts()</span></span><br><span class="line">	)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> instance = redigo.New(sentinelMode)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span>  &#123;</span><br><span class="line">		res, err := instance.String(<span class="function"><span class="keyword">func</span><span class="params">(c redis.Conn)</span> <span class="params">(res <span class="keyword">interface</span>&#123;&#125;, err error)</span></span> &#123;</span><br><span class="line">			<span class="keyword">return</span> c.Do(<span class="string">"set"</span>, <span class="string">"test"</span> + strconv.Itoa(i), i)</span><br><span class="line">		&#125;)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			log.Println(err)</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fmt.Println(res)</span><br><span class="line">		&#125;</span><br><span class="line">		i++</span><br><span class="line">		time.Sleep(<span class="number">1</span> * time.Second)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>执行以下命令，并模拟7000端口宕机<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go run client.go</span><br></pre></td></tr></table></figure><p></p><p><img src="/img/in-post/2019-01-19/16.png" alt=""></p><p>执行结果：</p><p><img src="/img/in-post/2019-01-19/14.png" alt=""><br><img src="/img/in-post/2019-01-19/15.png" alt=""></p><h2 id="日志分析"><a href="#日志分析" class="headerlink" title="日志分析"></a>日志分析</h2><p>查看7001.log</p><p><img src="/img/in-post/2019-01-19/17.png" alt=""></p><p>从日志中发现选举7002为master,执行<code>redis-cli -p 7002 info replication</code>验证下</p><p><img src="/img/in-post/2019-01-19/18.png" alt=""></p><p>看看sentinel日志的变化</p><p><img src="/img/in-post/2019-01-19/19.png" alt=""></p><h2 id="故障转移"><a href="#故障转移" class="headerlink" title="故障转移"></a>故障转移</h2><h3 id="三个定时任务"><a href="#三个定时任务" class="headerlink" title="三个定时任务"></a>三个定时任务</h3><ol><li>每10秒每个sentinel对master和slave执行info</li></ol><ul><li>发现slave节点</li><li>确定主从关系</li></ul><ol start="2"><li>每2秒每个sentinel通过master节点的channel节点交换信息(pub/sub)</li></ol><ul><li>通过<strong>sentinel</strong>和:hello频道交互</li><li>交互对节点的看法和自身的信息</li></ul><ol start="3"><li>每1秒每个Sentinel对其它Sentinel和Redis执行ping</li></ol><ul><li>失败判定依据，心跳检测</li></ul><h3 id="主观下线和客观下线"><a href="#主观下线和客观下线" class="headerlink" title="主观下线和客观下线"></a>主观下线和客观下线</h3><ul><li>主观下线：每个sentinel节点对Redis节点失败的偏见</li><li>客观下线：所有sentinel节点对Redis节点失败达成共识（quorum:建议节点数/2+1）</li></ul><h3 id="领导者选举"><a href="#领导者选举" class="headerlink" title="领导者选举"></a>领导者选举</h3><ul><li>原因：只有一个sentinel节点完成故障转移</li><li>选举：通过sentinel is-master-down-by-addr命令都希望成为领导者</li></ul><ol><li>每个主观下线的Sentinel节点向其他Sentinel节点发送命令，要求它设置为领导者</li><li>收到命令的Sentinel节点如果没有同意通过其他Sentinel节点发送的命令，那么该同意将被拒绝</li><li>如果该Sentinel节点发现通过的票数已经超过Sentinel集合半数且超过quorum，那么它将成为领导者</li><li>如果此过程中有多个Sentinel节点成为领导者，那么将等待一段时间重新选举</li></ol><h3 id="故障转移-1"><a href="#故障转移-1" class="headerlink" title="故障转移"></a>故障转移</h3><ol><li>从slave节点选出一个”合适的”节点作为新的master节点</li><li>对上面的slave节点执行<code>slaveof no one</code> 命令让其成为master节点</li><li>向剩余的slave节点发送命令，让他们成为新master节点的slave节点，复制规则和parallel-syncs参数有关</li><li>更新原来的master节点并配置为slave,并保持对其”关注”，当其恢复后，命令他去复制新的master节点</li></ol><h3 id="选择”合适的”slave节点"><a href="#选择”合适的”slave节点" class="headerlink" title="选择”合适的”slave节点"></a>选择”合适的”slave节点</h3><ol><li>选择slave-priority(slave节点优先级)最高的slave节点。如果存在则返回，不存在则继续</li><li>选择复制偏移量最大的slave节点(复制的最完整)如果存在则返回，不存在则继续</li><li>选择runid最小的slave节点</li></ol></div><div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/redis/" rel="tag"><i class="fa fa-tag"></i> redis</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/05/2019-01-05-golang-etcd/" rel="next" title="Golang etcd api"><i class="fa fa-chevron-left"></i> Golang etcd api</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/01/20/2019-01-20-redis-cluster/" rel="prev" title="Redis cluster">Redis cluster<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/pengshiliang.jpg" alt="enpsl"><p class="site-author-name" itemprop="name">enpsl</p><p class="site-description motion-element" itemprop="description">my blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/enpsl" title="GitHub &rarr; https://github.com/enpsl" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://weibo.com/pslpro" title="Weibo &rarr; https://weibo.com/pslpro" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> Weibo</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Redis-Sentinel基本架构"><span class="nav-number">1.</span> <span class="nav-text">Redis Sentinel基本架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装与配置"><span class="nav-number">2.</span> <span class="nav-text">安装与配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#sentinel配置"><span class="nav-number">2.1.</span> <span class="nav-text">sentinel配置:</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装演示"><span class="nav-number">2.2.</span> <span class="nav-text">安装演示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#go客户端"><span class="nav-number">3.</span> <span class="nav-text">go客户端</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#日志分析"><span class="nav-number">4.</span> <span class="nav-text">日志分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#故障转移"><span class="nav-number">5.</span> <span class="nav-text">故障转移</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#三个定时任务"><span class="nav-number">5.1.</span> <span class="nav-text">三个定时任务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主观下线和客观下线"><span class="nav-number">5.2.</span> <span class="nav-text">主观下线和客观下线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#领导者选举"><span class="nav-number">5.3.</span> <span class="nav-text">领导者选举</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#故障转移-1"><span class="nav-number">5.4.</span> <span class="nav-text">故障转移</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选择”合适的”slave节点"><span class="nav-number">5.5.</span> <span class="nav-text">选择”合适的”slave节点</span></a></li></ol></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">182k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">2:45</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"DEj2x1d388d2HxBNMAEETUPf-gzGzoHsz",appKey:"pMbUNFO55ydSxGeUNjhYJEUu",placeholder:"免登录，直接说",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body><script type="text/javascript" src="/js/src/wechat.js"></script></html>