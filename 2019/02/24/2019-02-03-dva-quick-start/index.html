<!DOCTYPE html><html class="theme-next gemini use-motion" lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#222"><script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script><link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet"><style>.pace .pace-progress{background:#1e92fb;height:3px}.pace .pace-progress-inner{box-shadow:0 0 10px #1e92fb,0 0 5px #1e92fb}.pace .pace-activity{border-top-color:#1e92fb;border-left-color:#1e92fb}</style><script></script><link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2"><link rel="stylesheet" href="/css/main.css?v=6.7.0"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.7.0"><link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.png?v=6.7.0"><link rel="mask-icon" href="/images/logo.svg?v=6.7.0" color="#222"><script id="hexo.configurations">var NexT=window.NexT||{},CONFIG={root:"/",scheme:"Gemini",version:"6.7.0",sidebar:{position:"left",display:"post",offset:12,b2t:!1,scrollpercent:!1,onmobile:!1},fancybox:!1,fastclick:!1,lazyload:!1,tabs:!0,motion:{enable:!0,async:!1,transition:{post_block:"fadeIn",post_header:"slideDownIn",post_body:"slideDownIn",coll_header:"slideLeftIn",sidebar:"slideUpIn"}},algolia:{applicationID:"",apiKey:"",indexName:"",hits:{per_page:10},labels:{input_placeholder:"Search for Posts",hits_empty:"We didn't find any results for the search: ${query}",hits_stats:"${hits} results found in ${time} ms"}}}</script><meta name="description" content="安装初始化项目123npm install -g dva-cli# 或yarn global add dva-cli 12345dva -vdva-cli version 0.10.0dva version 2.4.1roadhog version 2.4.9@local 12dva new dva-quickstartyarn install 目录说明 src文件夹内容：123456789101"><meta name="keywords" content="react,redux,Dva"><meta property="og:type" content="article"><meta property="og:title" content="Dva快速入门"><meta property="og:url" content="https://enpsl.github.io/2019/02/24/2019-02-03-dva-quick-start/index.html"><meta property="og:site_name" content="彭诗亮的博客"><meta property="og:description" content="安装初始化项目123npm install -g dva-cli# 或yarn global add dva-cli 12345dva -vdva-cli version 0.10.0dva version 2.4.1roadhog version 2.4.9@local 12dva new dva-quickstartyarn install 目录说明 src文件夹内容：123456789101"><meta property="og:locale" content="zh-CN"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/2.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/1.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/3.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/4.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/5.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/6.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/7.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/8.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/9.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/10.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/11.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/12.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/13.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/14.png"><meta property="og:image" content="https://enpsl.github.io/img/in-post/2019-02-23/15.png"><meta property="og:updated_time" content="2019-03-06T12:51:40.538Z"><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Dva快速入门"><meta name="twitter:description" content="安装初始化项目123npm install -g dva-cli# 或yarn global add dva-cli 12345dva -vdva-cli version 0.10.0dva version 2.4.1roadhog version 2.4.9@local 12dva new dva-quickstartyarn install 目录说明 src文件夹内容：123456789101"><meta name="twitter:image" content="https://enpsl.github.io/img/in-post/2019-02-23/2.png"><link rel="canonical" href="https://enpsl.github.io/2019/02/24/2019-02-03-dva-quick-start/"><script id="page.configurations">CONFIG.page={sidebar:""}</script><title>Dva快速入门 | 彭诗亮的博客</title><noscript><style>.sidebar-inner,.use-motion .brand,.use-motion .collection-title,.use-motion .comments,.use-motion .menu-item,.use-motion .motion-element,.use-motion .pagination,.use-motion .post-block,.use-motion .post-body,.use-motion .post-header{opacity:initial}.use-motion .logo,.use-motion .site-subtitle,.use-motion .site-title{opacity:initial;top:initial}.use-motion .logo-line-before i{left:initial}.use-motion .logo-line-after i{right:initial}</style></noscript></head><body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN"><div class="container sidebar-position-left page-post-detail"><div class="headband"><a href="https://github.com/enpsl/enpsl.github.io" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewbox="0 0 250 250" style="fill:#151513;color:#fff;position:absolute;top:0;border:0;right:0" aria-hidden="true"><path d="M0 0 115 115 130 115 142 142 250 250 250 0Z"/><path d="M128.3 109C113.8 99.7 119 89.6 119 89.6 122 82.7 120.5 78.6 120.5 78.6 119.2 72 123.4 76.3 123.4 76.3 127.3 80.9 125.5 87.3 125.5 87.3 122.9 97.6 130.6 101.9 134.4 103.2" fill="currentColor" style="transform-origin:130px 106px" class="octo-arm"/><path d="M115 115C114.9 115.1 118.7 116.5 119.8 115.4L133.7 101.6C136.9 99.2 139.9 98.4 142.2 98.6 133.8 88 127.5 74.4 143.8 58 148.5 53.4 154 51.2 159.7 51 160.3 49.4 163.2 43.6 171.4 40.1 171.4 40.1 176.1 42.5 178.8 56.2 183.1 58.6 187.2 61.8 190.9 65.4 194.5 69 197.7 73.2 200.1 77.6 213.8 80.2 216.3 84.9 216.3 84.9 212.7 93.1 206.9 96 205.4 96.6 205.1 102.4 203 107.8 198.3 112.5 181.9 128.9 168.3 122.5 157.7 114.1 157.9 116.9 156.7 120.9 152.7 124.9L141 136.5C139.8 137.7 141.6 141.9 141.8 141.8Z" fill="currentColor" class="octo-body"/></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div><header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader"><div class="header-inner"><div class="site-brand-wrapper"><div class="site-meta"><div class="custom-logo-site-title"><a href="/" class="brand" rel="start"><span class="logo-line-before"><i></i></span> <span class="site-title">彭诗亮的博客</span><span class="logo-line-after"><i></i></span></a></div></div><div class="site-nav-toggle"> <button aria-label="切换导航栏"><span class="btn-bar"></span><span class="btn-bar"></span><span class="btn-bar"></span></button></div></div><nav class="site-nav"><ul id="menu" class="menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i><br>首页</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i><br>关于</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i><br>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i><br>归档</a></li><li class="menu-item menu-item-golang-notes"><a href="/golang-note/" rel="section"><i class="menu-item-icon fa fa-fw fa-book"></i><br>golang-notes</a></li><li class="menu-item menu-item-resume"><a href="/resume/" rel="section"><i class="menu-item-icon fa fa-fw fa-sticky-note"></i><br>趣味简历示例</a></li><li class="menu-item menu-item-search"><a href="javascript:;" class="popup-trigger"><i class="menu-item-icon fa fa-search fa-fw"></i><br>搜索</a></li></ul><div class="site-search"><div class="popup search-popup local-search-popup"><div class="local-search-header clearfix"><span class="search-icon"><i class="fa fa-search"></i></span><span class="popup-btn-close"><i class="fa fa-times-circle"></i></span><div class="local-search-input-wrapper"> <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input"></div></div><div id="local-search-result"></div></div></div></nav></div></header><main id="main" class="main"><div class="main-inner"><div class="content-wrap"><div id="content" class="content"><div id="posts" class="posts-expand"><article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article"><div class="post-block"><link itemprop="mainEntityOfPage" href="https://enpsl.github.io/2019/02/24/2019-02-03-dva-quick-start/"><span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person"><meta itemprop="name" content="enpsl"><meta itemprop="description" content="my blog"><meta itemprop="image" content="/images/pengshiliang.jpg"></span><span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization"><meta itemprop="name" content="彭诗亮的博客"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">Dva快速入门</h1><div class="post-meta"><span class="post-time"><span class="post-meta-item-icon"><i class="fa fa-calendar-o"></i></span> <span class="post-meta-item-text">发表于</span> <time title="创建时间：2019-02-24 22:30:00" itemprop="dateCreated datePublished" datetime="2019-02-24T22:30:00+08:00">2019-02-24</time> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-calendar-check-o"></i></span> <span class="post-meta-item-text">更新于</span> <time title="修改时间：2019-03-06 20:51:40" itemprop="dateModified" datetime="2019-03-06T20:51:40+08:00">2019-03-06</time></span> <span class="post-comments-count"><span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-comment-o"></i></span> <a href="/2019/02/24/2019-02-03-dva-quick-start/#comments" itemprop="discussionUrl"><span class="post-meta-item-text">评论数：</span><span class="post-comments-count valine-comment-count" data-xid="/2019/02/24/2019-02-03-dva-quick-start/" itemprop="commentCount"></span></a></span><div class="post-symbolscount"><span class="post-meta-item-icon"><i class="fa fa-file-word-o"></i></span> <span class="post-meta-item-text">本文字数：</span> <span title="本文字数">12k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-clock-o"></i></span> <span class="post-meta-item-text">阅读时长 &asymp;</span> <span title="阅读时长">11 分钟</span></div></div></header><div class="post-body" itemprop="articleBody"><h2 id="安装初始化项目"><a href="#安装初始化项目" class="headerlink" title="安装初始化项目"></a>安装初始化项目</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install -g dva-cli</span><br><span class="line"><span class="comment"># 或</span></span><br><span class="line">yarn global add dva-cli</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">dva -v</span><br><span class="line">dva-cli version 0.10.0</span><br><span class="line">dva version 2.4.1</span><br><span class="line">roadhog version 2.4.9</span><br><span class="line">@<span class="built_in">local</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">dva new dva-quickstart</span><br><span class="line">yarn install</span><br></pre></td></tr></table></figure><h2 id="目录说明"><a href="#目录说明" class="headerlink" title="目录说明"></a>目录说明</h2><p><img src="/img/in-post/2019-02-23/2.png" align="left" width="100%/"></p><p>src文件夹内容：<br></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">src/</span><br><span class="line">├── assets</span><br><span class="line">│   └── yay.jpg</span><br><span class="line">├── components</span><br><span class="line">│   └── Example.js</span><br><span class="line">├── index.css</span><br><span class="line">├── index.js</span><br><span class="line">├── models</span><br><span class="line">│   └── example.js</span><br><span class="line">├── router.js</span><br><span class="line">├── routes</span><br><span class="line">│   ├── IndexPage.css</span><br><span class="line">│   └── IndexPage.js</span><br><span class="line">├── services</span><br><span class="line">│   └── example.js</span><br><span class="line">└── utils</span><br><span class="line">    └── request.js</span><br></pre></td></tr></table></figure><p></p><p>入口文件index.js默认内容<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dva <span class="keyword">from</span> <span class="string">'dva'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Initialize</span></span><br><span class="line"><span class="keyword">const</span> app = dva();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Plugins</span></span><br><span class="line"><span class="comment">// app.use(&#123;&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Model</span></span><br><span class="line"><span class="comment">// app.model(require('./models/example').default);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Router</span></span><br><span class="line">app.router(<span class="built_in">require</span>(<span class="string">'./router'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. Start</span></span><br><span class="line">app.start(<span class="string">'#root'</span>);</span><br></pre></td></tr></table></figure><p></p><p>路由文件默认内容：<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; Router, Route, Switch &#125; <span class="keyword">from</span> <span class="string">'dva/router'</span>;</span><br><span class="line"><span class="keyword">import</span> IndexPage <span class="keyword">from</span> <span class="string">'./routes/IndexPage'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">RouterConfig</span>(<span class="params">&#123; history &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Router history=&#123;history&#125;&gt;</span><br><span class="line">      &lt;Switch&gt;</span><br><span class="line">        &lt;Route path=<span class="string">"/"</span> exact component=&#123;IndexPage&#125; /&gt;</span><br><span class="line">      &lt;<span class="regexp">/Switch&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Router&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> RouterConfig;</span><br></pre></td></tr></table></figure><p></p><p>执行yarn start 即可看到页面效果<br><img src="/img/in-post/2019-02-23/1.png" alt=""></p><h2 id="计数器项目"><a href="#计数器项目" class="headerlink" title="计数器项目"></a>计数器项目</h2><h3 id="Router切换"><a href="#Router切换" class="headerlink" title="Router切换"></a>Router切换</h3><p><img src="/img/in-post/2019-02-23/3.png" align="left" width="100%/"></p><p>初始化项目的路由默认为HashRouter，路由链接不太友好更换为HashRouter<br>替换index.js文件内容<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> dva <span class="keyword">from</span> <span class="string">'dva'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; createBrowserHistory <span class="keyword">as</span> createHistory &#125; <span class="keyword">from</span> <span class="string">'history'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'./index.css'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1. Initialize</span></span><br><span class="line"><span class="keyword">const</span> app = dva(&#123;</span><br><span class="line">  history: createHistory()</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. Plugins</span></span><br><span class="line"><span class="comment">// app.use(&#123;&#125;);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 3. Model</span></span><br><span class="line"><span class="comment">// app.model(require('./models/example').default);</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 4. Router</span></span><br><span class="line">app.router(<span class="built_in">require</span>(<span class="string">'./router'</span>).default);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 5. Start</span></span><br><span class="line">app.start(<span class="string">'#root'</span>);</span><br></pre></td></tr></table></figure><p></p><p>再次访问<a href="http://localhost:8000" target="_blank" rel="noopener">http://localhost:8000</a>,路由正常显示<br><img src="/img/in-post/2019-02-23/4.png" align="left" width="100%/"></p><h3 id="编写Counter组件"><a href="#编写Counter组件" class="headerlink" title="编写Counter组件"></a>编写Counter组件</h3><p>新建 src/components/Counter.js</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;<span class="number">1</span>&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button&gt;+&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">export default Counter</span></span><br></pre></td></tr></table></figure><p>新建 src/routes/CounterPage.js</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> Counter <span class="keyword">from</span> <span class="string">'../components/Counter'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">const</span> CounterPage = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;counter&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Counter/</span>&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">export default CounterPage</span></span><br></pre></td></tr></table></figure><h3 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h3><p>在src/router.js中配置路由<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> CounterPage <span class="keyword">from</span> <span class="string">'./routes/CounterPage'</span>;</span><br><span class="line"></span><br><span class="line">&lt;Route path=<span class="string">"/counter"</span> exact component=&#123;CounterPage&#125; /&gt;</span><br></pre></td></tr></table></figure><p></p><p>页面效果<br><img src="/img/in-post/2019-02-23/5.png" alt=""></p><h3 id="定义model"><a href="#定义model" class="headerlink" title="定义model"></a>定义model</h3><p>新建 src/models/counter.js, copy models下面的Example.js内容到counter.js中，然后修改state和namespace内容</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line"></span><br><span class="line">  namespace: <span class="string">'counter'</span>,</span><br><span class="line"></span><br><span class="line">  state: &#123;</span><br><span class="line">    count: <span class="number">2</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch, history &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  effects: &#123;</span><br><span class="line">    *fetch(&#123; payload &#125;, &#123; call, put &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'save'</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  reducers: &#123;</span><br><span class="line">    save(state, action) &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123; ...state, ...action.payload &#125;;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><blockquote><p>dva中namespace作用类似于redux项目中combineReducers中的key，用来使各个组件中的state划分更清晰</p></blockquote><p><img src="/img/in-post/2019-02-23/6.png" alt=""></p><p>引入到入口文件index.js文件中<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">app.model(<span class="built_in">require</span>(<span class="string">'./models/counter'</span>).default);</span><br></pre></td></tr></table></figure><p></p><h4 id="model中的API介绍"><a href="#model中的API介绍" class="headerlink" title="model中的API介绍:"></a>model中的API介绍:</h4><p>参照<a href="https://dvajs.com/api/#reducers" target="_blank" rel="noopener">Dva API介绍</a>可了解到:</p><h5 id="namespace"><a href="#namespace" class="headerlink" title="namespace"></a>namespace</h5><p>model 的命名空间，同时也是他在全局 state 上的属性，只能用字符串，不支持通过 . 的方式创建多层命名空间。</p><h5 id="state"><a href="#state" class="headerlink" title="state"></a>state</h5><p>初始值，优先级低于传给 dva() 的 opts.initialState。</p><p>比如：<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> app = dva(&#123;</span><br><span class="line">  initialState: &#123; <span class="attr">count</span>: <span class="number">1</span> &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">app.model(&#123;</span><br><span class="line">  namespace: <span class="string">'count'</span>,</span><br><span class="line">  state: <span class="number">0</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p></p><p>此时，在 app.start() 后 state.count 为 1 。</p><h5 id="reducers"><a href="#reducers" class="headerlink" title="reducers"></a>reducers</h5><p>以 key/value 格式定义 reducer。用于处理同步操作，唯一可以修改 state 的地方。由 action 触发。格式为 (state, action) =&gt; newState 或 [(state, action) =&gt; newState, enhancer]。<br>详见:<a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/test/reducers.test.js" target="_blank" rel="noopener">https://github.com/dvajs/dva/blob/master/packages/dva-core/test/reducers.test.js</a></p><h5 id="effects"><a href="#effects" class="headerlink" title="effects"></a>effects</h5><p>以 key/value 格式定义 effect。用于处理异步操作和业务逻辑，不直接修改 state。由 action 触发，可以触发 action，可以和服务器交互，可以获取全局 state 的数据等等。格式为<em>(action, effects) =&gt; void或[</em>(action, effects) =&gt; void, { type }].<br>type 类型有：</p><ol><li>takeEvery</li><li>takeLatest</li><li>throttle</li><li>watcher</li></ol><p>详见：<a href="https://github.com/dvajs/dva/blob/master/packages/dva-core/test/effects.test.js" target="_blank" rel="noopener">https://github.com/dvajs/dva/blob/master/packages/dva-core/test/effects.test.js</a></p><h5 id="subscriptions"><a href="#subscriptions" class="headerlink" title="subscriptions"></a>subscriptions</h5><p>以 key/value 格式定义 subscription。subscription 是订阅，用于订阅一个数据源，然后根据需要 dispatch 相应的 action。在 app.start() 时被执行，数据源可以是当前的时间、服务器的 websocket 连接、keyboard 输入、geolocation 变化、history 路由变化等等。格式为({ dispatch, history }, done) =&gt; unlistenFunction。</p><blockquote><p>注意：如果要使用 app.unmodel()，subscription 必须返回 unlisten 方法，用于取消数据订阅。</p></blockquote><p>打开redux控制台:<br><img src="/img/in-post/2019-02-23/7.png" alt=""></p><p>可看到state.counter.count</p><blockquote><p>counter对应model的namespace,count对应state对象中的count</p></blockquote><h3 id="connect起来"><a href="#connect起来" class="headerlink" title="connect起来"></a>connect起来</h3><p>修改src/components/Counter.js的内容</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">"dva"</span>;</span><br><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;h1&gt;&#123;props.counter.count&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button&gt;+&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ 取出models下的命名空间counter</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    counter: state.counter</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps)(Counter)</span></span><br></pre></td></tr></table></figure><blockquote><p>这一步做的主要是把models/counter和当前组件通过mapStateToProps连接然后在无状态Counter组件中通过props来接收</p></blockquote><p>可以看到如果在models中的state定义的对象如果结构很长的话,Counter组件中的props链式对象会写的很长，当然我们可以通过es6中的对象析构来优化代码</p><p>优化后的代码:</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Fragment&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">"dva"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">&#123;count&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Fragment&gt;</span><br><span class="line">      &lt;h1&gt;&#123;count&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button&gt;+&lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/Fragment&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ 取出models下的命名空间counter</span></span><br><span class="line"><span class="regexp">  const &#123; count &#125; = state.counter;</span></span><br><span class="line"><span class="regexp">  return &#123;</span></span><br><span class="line"><span class="regexp">    count</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp">export default connect(mapStateToProps)(Counter)</span></span><br></pre></td></tr></table></figure><p>重新访问<a href="http://localhost:8000/counter" target="_blank" rel="noopener">http://localhost:8000/counter</a>,依然正常显示</p><p><img src="/img/in-post/2019-02-23/8.png" alt=""></p><h4 id="定义propTypes-数据类型检查"><a href="#定义propTypes-数据类型检查" class="headerlink" title="定义propTypes(数据类型检查)"></a>定义propTypes(数据类型检查)</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span></span><br><span class="line">Counter.propTypes = &#123;</span><br><span class="line">  count: PropTypes.number</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="dispatch"><a href="#dispatch" class="headerlink" title="dispatch"></a>dispatch</h3><p>修改Counter组件代码，给button增加一个点击事件<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">&#123;count, dispatch&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Fragment&gt;</span><br><span class="line">      &lt;h1&gt;&#123;count&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "counter/</span>add<span class="string">"&#125;)&#125;&#125;&gt;+&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/Fragment&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure><p></p><blockquote><p>type中必须以namespace/action 的形式传递，否则在reducer中会捕获不到</p></blockquote><p>按钮点击后会dispatch一个action{type: “counter/add”}到reducer中<br>控制台效果：<br><img src="/img/in-post/2019-02-23/9.png" alt=""></p><h3 id="编写reducers"><a href="#编写reducers" class="headerlink" title="编写reducers"></a>编写reducers</h3><p>修改src/models/counter.js,修改reducers部分代码<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reducers: &#123;</span><br><span class="line">    add(state, action) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(action);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        count: state.count+<span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p></p><p>修改src/components/Counter.js,增加Dispatch传递的参数<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;<span class="attr">type</span>: <span class="string">"counter/add"</span>, <span class="attr">names</span>: <span class="string">"psl"</span>&#125;)&#125;&#125;&gt;+&lt;/button&gt;</span><br></pre></td></tr></table></figure><p></p><p>页面效果：<br><img src="/img/in-post/2019-02-23/10.png" alt=""><br>有时候，当项目非常复杂的时候，为了便于管理reducers中的函数，reducers中的函数也可以这么写</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reducers: &#123;</span><br><span class="line">    <span class="string">'add'</span>(state, action) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(action);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        count: state.count+<span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>增加type层级<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;<span class="attr">type</span>: <span class="string">"counter/add/num"</span>, <span class="attr">names</span>: <span class="string">"psl"</span>&#125;)&#125;&#125;&gt;+&lt;/button&gt;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reducers: &#123;</span><br><span class="line">    <span class="string">'add/num'</span>(state, action) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(action);</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        count: state.count+<span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure><p>页面效果：<br><img src="/img/in-post/2019-02-23/11.png" alt=""></p><h3 id="异步动作"><a href="#异步动作" class="headerlink" title="异步动作"></a>异步动作</h3><h4 id="修改effects"><a href="#修改effects" class="headerlink" title="修改effects"></a>修改effects</h4><p>dva中的异步动作要放到effects中来触发,放到effects中可以使用call,put等方法,也就是redux-saga中的一些方法<br>修改src/components/Counter.js,新增加一个button</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;<span class="attr">type</span>: <span class="string">"counter/asyncAdd"</span>&#125;)&#125;&#125;&gt;asyncAdd+&lt;/button&gt;</span><br></pre></td></tr></table></figure><p>修改src/models/counter.js中的effects<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">effects: &#123;</span><br><span class="line">    *asyncAdd(&#123; payload &#125;, &#123; call, put &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'add/num'</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p></p><blockquote><p>yield put({ type: ‘add/num’ }) 会触发reducers中的add方法，由于是同命名空间下，所以不用加入namespace层级</p></blockquote><p>查看redux控制台效果<br><img src="/img/in-post/2019-02-23/12.png" alt=""></p><p>effects中asyncAdd方法中的payload可以接收dispatch过来的额外的参数<br>例如:</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;<span class="attr">type</span>: <span class="string">"counter/asyncAdd"</span>, <span class="attr">payload</span>: <span class="string">"payload"</span>&#125;)&#125;&#125;&gt;asyncAdd+&lt;/button&gt;</span><br></pre></td></tr></table></figure><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">effects: &#123;</span><br><span class="line">    *asyncAdd(&#123; payload &#125;, &#123; call, put &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="built_in">console</span>.log(payload);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'add/num'</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>查看redux控制台效果<br><img src="/img/in-post/2019-02-23/13.png" alt=""></p><h4 id="延时函数"><a href="#延时函数" class="headerlink" title="延时函数"></a>延时函数</h4><p>修改src/models/counter.js中的effects</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;delay&#125; <span class="keyword">from</span> <span class="string">'dva/saga'</span></span><br><span class="line">effects: &#123;</span><br><span class="line">    *asyncAdd(&#123; payload &#125;, &#123; call, put &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="keyword">yield</span> call(delay, <span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'add/num'</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><h4 id="select"><a href="#select" class="headerlink" title="select"></a>select</h4><p>select 用于取state中的数据<br>引入select:</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">effects: &#123;</span><br><span class="line">    *asyncAdd(&#123; payload &#125;, &#123; call, put, select &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="keyword">const</span> counter = <span class="keyword">yield</span> select(<span class="function"><span class="params">state</span> =&gt;</span> state.counter);</span><br><span class="line">      <span class="built_in">console</span>.log(counter);</span><br><span class="line">      <span class="keyword">yield</span> call(delay, <span class="number">1000</span>);</span><br><span class="line">      <span class="keyword">yield</span> put(&#123; <span class="attr">type</span>: <span class="string">'add/num'</span> &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br></pre></td></tr></table></figure><p>查看控制台效果<br><img src="/img/in-post/2019-02-23/14.png" alt=""></p><p>几种不同的写法:<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// const counter = yield select(state =&gt; state.counter);</span></span><br><span class="line"><span class="comment">// const counter = yield select((&#123;counter&#125;) =&gt; counter);</span></span><br><span class="line"><span class="comment">// const counter = yield select(_ =&gt; _.counter);</span></span><br><span class="line"><span class="keyword">const</span> &#123; counter &#125; = <span class="keyword">yield</span> select(<span class="function"><span class="params">_</span> =&gt;</span> _);</span><br><span class="line"><span class="built_in">console</span>.log(counter);</span><br></pre></td></tr></table></figure><p></p><h3 id="路由跳转"><a href="#路由跳转" class="headerlink" title="路由跳转"></a>路由跳转</h3><h4 id="withRouter"><a href="#withRouter" class="headerlink" title="withRouter"></a>withRouter</h4><p>修改src/components/Counter.js</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React, &#123;Fragment&#125; <span class="keyword">from</span> <span class="string">'react'</span></span><br><span class="line"><span class="keyword">import</span> &#123;connect&#125; <span class="keyword">from</span> <span class="string">"dva"</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span></span><br><span class="line"><span class="keyword">import</span> &#123;withRouter&#125; <span class="keyword">from</span> <span class="string">'dva/router'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">&#123;count, dispatch, history&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Fragment&gt;</span><br><span class="line">      &lt;h1&gt;&#123;count&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; &#123;history.push("/</span><span class="string">")&#125;&#125;&gt;go home&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "</span>counter/add/num<span class="string">", names: "</span>psl<span class="string">"&#125;)&#125;&#125;&gt;+&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "</span>counter/asyncAdd<span class="string">", payload: "</span>payload<span class="string">"&#125;)&#125;&#125;&gt;asyncAdd+&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/Fragment&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Counter.propTypes = &#123;</span></span><br><span class="line"><span class="string">  count: PropTypes.number</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const mapStateToProps = (state) =&gt; &#123;</span></span><br><span class="line"><span class="string">  // 取出models下的命名空间counter</span></span><br><span class="line"><span class="string">  const &#123; count &#125; = state.counter;</span></span><br><span class="line"><span class="string">  return &#123;</span></span><br><span class="line"><span class="string">    count</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">export default connect(mapStateToProps)(withRouter(Counter))</span></span><br></pre></td></tr></table></figure><h4 id="在effects中的路由跳转"><a href="#在effects中的路由跳转" class="headerlink" title="在effects中的路由跳转"></a>在effects中的路由跳转</h4><p>修改src/models/counter.js</p><p>引入routerRedux:<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;routerRedux&#125; <span class="keyword">from</span> <span class="string">'dva/router'</span></span><br></pre></td></tr></table></figure><p></p><p>在effects中增加redirect方法:<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">*redirect(&#123; _ &#125;, &#123; call, put &#125;) &#123;</span><br><span class="line">  <span class="keyword">yield</span> put(routerRedux.push(<span class="string">"/"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>修改src/components/Counter.js中的Counter组件</p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Counter = <span class="function">(<span class="params">&#123;count, dispatch, history&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;Fragment&gt;</span><br><span class="line">      &lt;h1&gt;&#123;count&#125;&lt;<span class="regexp">/h1&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; &#123;history.push("/</span><span class="string">")&#125;&#125;&gt;go home&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "</span>counter/redirect<span class="string">"&#125;)&#125;&#125;&gt;go home by effects&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "</span>counter/add/num<span class="string">", names: "</span>psl<span class="string">"&#125;)&#125;&#125;&gt;+&lt;/button&gt;</span></span><br><span class="line"><span class="string">      &lt;button onClick=&#123;() =&gt; &#123;dispatch(&#123;type: "</span>counter/asyncAdd<span class="string">", payload: "</span>payload<span class="string">"&#125;)&#125;&#125;&gt;asyncAdd+&lt;/button&gt;</span></span><br><span class="line"><span class="string">    &lt;/Fragment&gt;</span></span><br><span class="line"><span class="string">  );</span></span><br><span class="line"><span class="string">&#125;;</span></span><br></pre></td></tr></table></figure><h4 id="带参数的跳转"><a href="#带参数的跳转" class="headerlink" title="带参数的跳转"></a>带参数的跳转</h4><p>修改src/models/counter.js</p><p>引入query-string:<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123;queryString&#125; <span class="keyword">from</span> <span class="string">'query-string'</span></span><br></pre></td></tr></table></figure><p></p><p>修改effects中的redirect<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">*redirect(&#123; _ &#125;, &#123; call, put &#125;) &#123;</span><br><span class="line">  <span class="comment">// yield put(routerRedux.push("/"));</span></span><br><span class="line">  <span class="keyword">yield</span> put(routerRedux.push(&#123;</span><br><span class="line">    pathname: <span class="string">'/'</span>,</span><br><span class="line">    search: queryString.stringify(&#123;</span><br><span class="line">      <span class="keyword">from</span>: <span class="string">"psl"</span></span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p></p><p>点击按钮后跳转到<a href="http://localhost:8000/?from=psl" target="_blank" rel="noopener">http://localhost:8000/?from=psl</a></p><h3 id="subscriptions-1"><a href="#subscriptions-1" class="headerlink" title="subscriptions"></a>subscriptions</h3><h4 id="dispatch-1"><a href="#dispatch-1" class="headerlink" title="dispatch"></a>dispatch</h4><p>监听窗口改变触发add/num方法:<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">subscriptions: &#123;</span><br><span class="line">    setup(&#123; dispatch, history &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">      <span class="built_in">window</span>.onresize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        dispatch(&#123;<span class="attr">type</span>: <span class="string">'add/num'</span>&#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p></p><blockquote><p>setup可以为多个，可以同时订阅多个监听事件</p></blockquote><h4 id="history"><a href="#history" class="headerlink" title="history"></a>history</h4><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setupHistory(&#123; dispatch, history &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">  history.listen(<span class="function">(<span class="params">location</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(location)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p>控制台输出：</p><p><img src="/img/in-post/2019-02-23/15.png" alt=""></p><p>可以发现location中包含pathname,search,hash,state等参数，我们可以通过析构对象来做一些特殊事情</p><p>例如：<br></p><figure class="highlight jsx"><figcaption><span>harmony</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">setupHistory(&#123; dispatch, history &#125;) &#123;  <span class="comment">// eslint-disable-line</span></span><br><span class="line">  history.listen(<span class="function">(<span class="params">&#123;pathname&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (pathname === <span class="string">"/counter"</span>) &#123;</span><br><span class="line">      dispatch(&#123;<span class="attr">type</span>: <span class="string">'add/num'</span>&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure><p></p></div><div></div><div><div><div style="text-align:center;color:#ccc;font-size:14px">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div></div></div><footer class="post-footer"><div class="post-tags"><a href="/tags/react/" rel="tag"><i class="fa fa-tag"></i> react</a><a href="/tags/redux/" rel="tag"><i class="fa fa-tag"></i> redux</a><a href="/tags/Dva/" rel="tag"><i class="fa fa-tag"></i> Dva</a></div><div class="post-widgets"><div class="social_share"><div><div class="bdsharebuttonbox"><a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a><a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a><a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a><a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a><a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a><a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a><a href="#" class="bds_more" data-cmd="more"></a><a class="bds_count" data-cmd="count"></a></div><script>window._bd_share_config={common:{bdText:"",bdMini:"2",bdMiniList:!1,bdPic:""},share:{bdSize:"16",bdStyle:"0"},image:{viewList:["tsina","douban","sqq","qzone","weixin","twi","fbook"],viewText:"分享到：",viewSize:"16"}}</script><script>with(document)(getElementsByTagName("head")[0]||body).appendChild(createElement("script")).src="/static/api/js/share.js?cdnversion="+~(-new Date/36e5)</script></div></div></div><div class="post-nav"><div class="post-nav-next post-nav-item"><a href="/2019/01/25/2019-01-25-redis-cluster-out/" rel="next" title="Redis cluster 故障转移"><i class="fa fa-chevron-left"></i> Redis cluster 故障转移</a></div><span class="post-nav-divider"></span><div class="post-nav-prev post-nav-item"> <a href="/2019/02/24/2019-02-24-mysql(1)/" rel="prev" title="Mysql锁">Mysql锁<i class="fa fa-chevron-right"></i></a></div></div></footer></div></article></div></div><div class="comments" id="comments"></div></div><div class="sidebar-toggle"><div class="sidebar-toggle-line-wrap"><span class="sidebar-toggle-line sidebar-toggle-line-first"></span><span class="sidebar-toggle-line sidebar-toggle-line-middle"></span><span class="sidebar-toggle-line sidebar-toggle-line-last"></span></div></div><aside id="sidebar" class="sidebar"><div class="sidebar-inner"><ul class="sidebar-nav motion-element"><li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap"> 文章目录</li><li class="sidebar-nav-overview" data-target="site-overview-wrap"> 站点概览</li></ul><div class="site-overview-wrap sidebar-panel"><div class="site-overview"><div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person"> <img class="site-author-image" itemprop="image" src="/images/pengshiliang.jpg" alt="enpsl"><p class="site-author-name" itemprop="name">enpsl</p><p class="site-description motion-element" itemprop="description">my blog</p></div><nav class="site-state motion-element"><div class="site-state-item site-state-posts"> <a href="/archives/"><span class="site-state-item-count">34</span> <span class="site-state-item-name">文章</span></a></div><div class="site-state-item site-state-tags"> <a href="/tags/index.html"><span class="site-state-item-count">23</span> <span class="site-state-item-name">标签</span></a></div></nav><div class="links-of-author motion-element"><span class="links-of-author-item"><a href="https://github.com/enpsl" title="GitHub &rarr; https://github.com/enpsl" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> GitHub</a></span><span class="links-of-author-item"><a href="https://weibo.com/pslpro" title="Weibo &rarr; https://weibo.com/pslpro" rel="noopener" target="_blank"><i class="fa fa-fw fa-globe"></i> Weibo</a></span></div></div></div><div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active"><div class="post-toc"><div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#安装初始化项目"><span class="nav-number">1.</span> <span class="nav-text">安装初始化项目</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#目录说明"><span class="nav-number">2.</span> <span class="nav-text">目录说明</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#计数器项目"><span class="nav-number">3.</span> <span class="nav-text">计数器项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Router切换"><span class="nav-number">3.1.</span> <span class="nav-text">Router切换</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写Counter组件"><span class="nav-number">3.2.</span> <span class="nav-text">编写Counter组件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#配置路由"><span class="nav-number">3.3.</span> <span class="nav-text">配置路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#定义model"><span class="nav-number">3.4.</span> <span class="nav-text">定义model</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#model中的API介绍"><span class="nav-number">3.4.1.</span> <span class="nav-text">model中的API介绍:</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#namespace"><span class="nav-number">3.4.1.1.</span> <span class="nav-text">namespace</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#state"><span class="nav-number">3.4.1.2.</span> <span class="nav-text">state</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#reducers"><span class="nav-number">3.4.1.3.</span> <span class="nav-text">reducers</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#effects"><span class="nav-number">3.4.1.4.</span> <span class="nav-text">effects</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#subscriptions"><span class="nav-number">3.4.1.5.</span> <span class="nav-text">subscriptions</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connect起来"><span class="nav-number">3.5.</span> <span class="nav-text">connect起来</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#定义propTypes-数据类型检查"><span class="nav-number">3.5.1.</span> <span class="nav-text">定义propTypes(数据类型检查)</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#dispatch"><span class="nav-number">3.6.</span> <span class="nav-text">dispatch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#编写reducers"><span class="nav-number">3.7.</span> <span class="nav-text">编写reducers</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#异步动作"><span class="nav-number">3.8.</span> <span class="nav-text">异步动作</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改effects"><span class="nav-number">3.8.1.</span> <span class="nav-text">修改effects</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#延时函数"><span class="nav-number">3.8.2.</span> <span class="nav-text">延时函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#select"><span class="nav-number">3.8.3.</span> <span class="nav-text">select</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由跳转"><span class="nav-number">3.9.</span> <span class="nav-text">路由跳转</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#withRouter"><span class="nav-number">3.9.1.</span> <span class="nav-text">withRouter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#在effects中的路由跳转"><span class="nav-number">3.9.2.</span> <span class="nav-text">在effects中的路由跳转</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#带参数的跳转"><span class="nav-number">3.9.3.</span> <span class="nav-text">带参数的跳转</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#subscriptions-1"><span class="nav-number">3.10.</span> <span class="nav-text">subscriptions</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dispatch-1"><span class="nav-number">3.10.1.</span> <span class="nav-text">dispatch</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#history"><span class="nav-number">3.10.2.</span> <span class="nav-text">history</span></a></li></ol></li></ol></li></ol></div></div></div></div></aside></div></main><footer id="footer" class="footer"><div class="footer-inner"><div class="copyright">&copy; <span itemprop="copyrightYear">2019</span><span class="with-love" id="animate"><i class="fa fa-user"></i></span> <span class="author" itemprop="copyrightHolder">enpsl</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-area-chart"></i></span> <span title="站点总字数">189k</span> <span class="post-meta-divider">|</span><span class="post-meta-item-icon"><i class="fa fa-coffee"></i></span> <span title="站点阅读时长">2:52</span></div></div></footer><div class="back-to-top"><i class="fa fa-arrow-up"></i></div></div><script>"[object Function]"!==Object.prototype.toString.call(window.Promise)&&(window.Promise=null)</script><script src="/lib/jquery/index.js?v=2.1.3"></script><script src="/lib/velocity/velocity.min.js?v=1.2.1"></script><script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script><script src="/js/src/utils.js?v=6.7.0"></script><script src="/js/src/motion.js?v=6.7.0"></script><script src="/js/src/affix.js?v=6.7.0"></script><script src="/js/src/schemes/pisces.js?v=6.7.0"></script><script src="/js/src/scrollspy.js?v=6.7.0"></script><script src="/js/src/post-details.js?v=6.7.0"></script><script src="/js/src/bootstrap.js?v=6.7.0"></script><script src="//cdn1.lncld.net/static/js/3.11.1/av-min.js"></script><script src="//unpkg.com/valine/dist/Valine.min.js"></script><script>var GUEST=["nick","mail","link"],guest="nick,mail,link";guest=guest.split(",").filter(function(e){return-1<GUEST.indexOf(e)}),new Valine({el:"#comments",verify:!1,notify:!1,appId:"DEj2x1d388d2HxBNMAEETUPf-gzGzoHsz",appKey:"pMbUNFO55ydSxGeUNjhYJEUu",placeholder:"免登录，直接说",avatar:"mm",meta:guest,pageSize:"10",visitor:!1})</script><script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script></body><script type="text/javascript" src="/js/src/wechat.js"></script></html>